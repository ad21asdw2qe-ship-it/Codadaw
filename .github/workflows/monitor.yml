name: SA-MP Monitor
on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check server online and update JSON
        run: |
          python3 -c "
          import socket, struct, json, datetime
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–Ω–ª–∞–π–Ω
          try:
              sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
              sock.settimeout(5)
              packet = b'SAMP' + bytes([193,23,220,249]) + struct.pack('<H', 1171) + b'i'
              sock.sendto(packet, ('193.23.220.249', 1171))
              response, addr = sock.recvfrom(4096)
              if response[10] == 105:
                  players = struct.unpack('<H', response[12:14])[0]
                  print(f'üü¢ {datetime.datetime.now().strftime(\"%H:%M:%S\")} | –û–Ω–ª–∞–π–Ω: {players} –∏–≥—Ä–æ–∫–æ–≤')
              else:
                  players = 0
                  print('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç')
          except Exception as e:
              players = 0
              print(f'‚ùå –û—à–∏–±–∫–∞: {e}')
          
          # –û–±–Ω–æ–≤–ª—è–µ–º servers.json
          with open('servers.json', 'r') as f:
              servers = json.load(f)
          
          for server in servers:
              server['online'] = players
          
          with open('servers.json', 'w') as f:
              json.dump(servers, f, indent=4)
          
          print('‚úÖ servers.json –æ–±–Ω–æ–≤–ª–µ–Ω')
          "
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add servers.json
          git commit -m "Update online: ${{ job.status }}" || exit 0
          git push
