import socket
import struct
import time
import requests
import json

def update_ftp(online):
    try:
        response = requests.get('http://a1189822.xsph.ru/servers.json')
        servers = response.json()
        for server in servers:
            server['online'] = online
            
        files = {'file': ('servers.json', json.dumps(servers, indent=2))}
        auth = ('blaze@a1189822', 'OsoW_123')
        requests.put('ftp://a1189822.xsph.ru/servers.json', files=files, auth=auth)
        print(f'‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω: {online}')
    except Exception as e:
        print(f'‚ùå –û—à–∏–±–∫–∞: {e}')

def check_server():
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(5)
        packet = b'SAMP' + bytes([193,23,220,249]) + struct.pack('<H', 1171) + b'i'
        sock.sendto(packet, ('193.23.220.249', 1171))
        response, addr = sock.recvfrom(4096)
        sock.close()
        
        if response[10] == 105:
            return struct.unpack('<H', response[12:14])[0]
    except:
        return 0
    return 0

print('üü¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω')
last_online = 0

while True:
    online = check_server()
    if online != last_online:
        print(f'üîÑ –ò–∑–º–µ–Ω–∏–ª—Å—è: {last_online} -> {online}')
        update_ftp(online)
        last_online = online
    else:
        print(f'‚è≥ –û–Ω–ª–∞–π–Ω: {online}')
    time.sleep(5)
