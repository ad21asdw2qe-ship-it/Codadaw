name: SA-MP Monitor
on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Download servers.json
        run: curl -o servers.json "http://a1189822.xsph.ru/servers.json"
        
      - name: Check server online
        run: |
          python3 -c "
          import socket, struct, json, datetime
          
          # –î–µ–ª–∞–µ–º 2 –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ä—è–¥ —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
          players = 0
          for i in range(2):
              try:
                  sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
                  sock.settimeout(5)
                  packet = b'SAMP' + bytes([193,23,220,249]) + struct.pack('<H', 1171) + b'i'
                  sock.sendto(packet, ('193.23.220.249', 1171))
                  response, addr = sock.recvfrom(4096)
                  
                  if response[10] == 105:
                      current_players = struct.unpack('<H', response[12:14])[0]
                      print(f'üü¢ –ó–∞–ø—Ä–æ—Å {i+1}: {current_players} –∏–≥—Ä–æ–∫–æ–≤')
                      players = current_players  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                      
                  time.sleep(1)
                  
              except Exception as e:
                  print(f'‚ùå –û—à–∏–±–∫–∞: {e}')
          
          print(f'üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–Ω–ª–∞–π–Ω: {players} –∏–≥—Ä–æ–∫–æ–≤')
          
          # –û–±–Ω–æ–≤–ª—è–µ–º JSON
          with open('servers.json', 'r') as f:
              servers = json.load(f)
          
          for server in servers:
              server['online'] = players
          
          with open('servers.json', 'w') as f:
              json.dump(servers, f, indent=4)
          "
          
      - name: Upload to FTP
        run: curl -T servers.json --user blaze@a1189822:OsoW_123 "ftp://a1189822.xsph.ru/public_html/servers.json"
